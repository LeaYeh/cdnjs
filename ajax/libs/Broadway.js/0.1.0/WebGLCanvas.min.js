(function(a,b){if(typeof define==="function"&&define.amd){define([],b)}else{if(typeof exports==="object"){module.exports=b()}else{a.WebGLCanvas=b()}}}(this,function(){function a(c,d,b){this.canvasElement=c;this.contextOptions=b;if(!d){this.initContextGL()}if(this.contextGL){this.initProgram();this.initBuffers();this.initTextures()}}a.prototype.isWebGL=function(){return this.contextGL};a.prototype.initContextGL=function(){var b=this.canvasElement;var h=null;var d=["webgl","experimental-webgl","moz-webgl","webkit-3d"];var c=0;while(!h&&c<d.length){var g=d[c];try{if(this.contextOptions){h=b.getContext(g,this.contextOptions)}else{h=b.getContext(g)}}catch(f){h=null}if(!h||typeof h.getParameter!=="function"){h=null}++c}this.contextGL=h};a.prototype.initProgram=function(){var g=this.contextGL;var f=["attribute vec4 vertexPos;","attribute vec4 texturePos;","varying vec2 textureCoord;","void main()","{","gl_Position = vertexPos;","textureCoord = texturePos.xy;","}"].join("\n");var e=["precision highp float;","varying highp vec2 textureCoord;","uniform sampler2D ySampler;","uniform sampler2D uSampler;","uniform sampler2D vSampler;","const mat4 YUV2RGB = mat4","(","1.1643828125, 0, 1.59602734375, -.87078515625,","1.1643828125, -.39176171875, -.81296875, .52959375,","1.1643828125, 2.017234375, 0, -1.081390625,","0, 0, 0, 1",");","void main(void) {","highp float y = texture2D(ySampler,  textureCoord).r;","highp float u = texture2D(uSampler,  textureCoord).r;","highp float v = texture2D(vSampler,  textureCoord).r;","gl_FragColor = vec4(y, u, v, 1) * YUV2RGB;","}"].join("\n");var d=g.createShader(g.VERTEX_SHADER);g.shaderSource(d,f);g.compileShader(d);if(!g.getShaderParameter(d,g.COMPILE_STATUS)){console.log("Vertex shader failed to compile: "+g.getShaderInfoLog(d))}var b=g.createShader(g.FRAGMENT_SHADER);g.shaderSource(b,e);g.compileShader(b);if(!g.getShaderParameter(b,g.COMPILE_STATUS)){console.log("Fragment shader failed to compile: "+g.getShaderInfoLog(b))}var c=g.createProgram();g.attachShader(c,d);g.attachShader(c,b);g.linkProgram(c);if(!g.getProgramParameter(c,g.LINK_STATUS)){console.log("Program failed to compile: "+g.getProgramInfoLog(c))}g.useProgram(c);this.shaderProgram=c};a.prototype.initBuffers=function(){var g=this.contextGL;var b=this.shaderProgram;var c=g.createBuffer();g.bindBuffer(g.ARRAY_BUFFER,c);g.bufferData(g.ARRAY_BUFFER,new Float32Array([1,1,-1,1,1,-1,-1,-1]),g.STATIC_DRAW);var e=g.getAttribLocation(b,"vertexPos");g.enableVertexAttribArray(e);g.vertexAttribPointer(e,2,g.FLOAT,false,0,0);var d=g.createBuffer();g.bindBuffer(g.ARRAY_BUFFER,d);g.bufferData(g.ARRAY_BUFFER,new Float32Array([1,0,0,0,1,1,0,1]),g.STATIC_DRAW);var f=g.getAttribLocation(b,"texturePos");g.enableVertexAttribArray(f);g.vertexAttribPointer(f,2,g.FLOAT,false,0,0);this.texturePosBuffer=d};a.prototype.initTextures=function(){var i=this.contextGL;var c=this.shaderProgram;var g=this.initTexture();var d=i.getUniformLocation(c,"ySampler");i.uniform1i(d,0);this.yTextureRef=g;var f=this.initTexture();var b=i.getUniformLocation(c,"uSampler");i.uniform1i(b,1);this.uTextureRef=f;var h=this.initTexture();var e=i.getUniformLocation(c,"vSampler");i.uniform1i(e,2);this.vTextureRef=h};a.prototype.initTexture=function(){var c=this.contextGL;var b=c.createTexture();c.bindTexture(c.TEXTURE_2D,b);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE);c.bindTexture(c.TEXTURE_2D,null);return b};a.prototype.drawNextOutputPicture=function(d,b,c,e){var f=this.contextGL;if(f){this.drawNextOuptutPictureGL(d,b,c,e)}else{this.drawNextOuptutPictureRGBA(d,b,c,e)}};a.prototype.drawNextOuptutPictureGL=function(o,l,i,v){var q=this.contextGL;var c=this.texturePosBuffer;var j=this.yTextureRef;var m=this.uTextureRef;var r=this.vTextureRef;if(i===null){q.viewport(0,0,o,l)}else{q.viewport(0,0,i.width,i.height);var d=i.top/l;var b=i.left/o;var h=i.height/l;var k=i.width/o;var u=new Float32Array([k,d,b,d,k,h,b,h]);q.bindBuffer(q.ARRAY_BUFFER,c);q.bufferData(q.ARRAY_BUFFER,u,q.DYNAMIC_DRAW)}var g=v;var s=o*l;var t=g.subarray(0,s);q.activeTexture(q.TEXTURE0);q.bindTexture(q.TEXTURE_2D,j);q.texImage2D(q.TEXTURE_2D,0,q.LUMINANCE,o,l,0,q.LUMINANCE,q.UNSIGNED_BYTE,t);var f=o/2*l/2;var p=g.subarray(s,s+f);q.activeTexture(q.TEXTURE1);q.bindTexture(q.TEXTURE_2D,m);q.texImage2D(q.TEXTURE_2D,0,q.LUMINANCE,o/2,l/2,0,q.LUMINANCE,q.UNSIGNED_BYTE,p);var e=f;var n=g.subarray(s+f,s+f+e);q.activeTexture(q.TEXTURE2);q.bindTexture(q.TEXTURE_2D,r);q.texImage2D(q.TEXTURE_2D,0,q.LUMINANCE,o/2,l/2,0,q.LUMINANCE,q.UNSIGNED_BYTE,n);q.drawArrays(q.TRIANGLE_STRIP,0,4)};a.prototype.drawNextOuptutPictureRGBA=function(f,b,d,h){var e=this.canvasElement;var d=null;var g=h;var c=e.getContext("2d");var i=c.getImageData(0,0,f,b);i.data.set(g);if(d===null){c.putImageData(i,0,0)}else{c.putImageData(i,-d.left,-d.top,0,0,d.width,d.height)}};return a}));