!function(a,b){"function"==typeof define&&define.amd?define([],b):"object"==typeof exports?module.exports=b():a.loki=b()}(this,function(){return function(){"use strict";function b(a,b,c){return a===b?c?!0:!1:void 0===a?!0:void 0===b?!1:null===a?!0:null===b?!1:b>a}function c(a,b,c){return a===b?c?!0:!1:void 0===a?!1:void 0===b?!0:null===a?!1:null===b?!0:a>b}function d(a,d,e){return a===d?0:e?b(a,d)?1:-1:c(a,d)?1:-1}function e(a){return Array.isArray(a)?function(b){return-1!==a.indexOf(b)}:"string"==typeof a?function(b){return-1!==a.indexOf(b)}:a&&"object"==typeof a?function(b){return a.hasOwnProperty(b)}:void 0}function h(a,b){var d,c=b||"parse-stringify";return"parse-stringify"===c&&(d=JSON.parse(JSON.stringify(a))),d}function i(){try{return"localStorage"in window&&null!==window.localStorage}catch(a){return!1}}function j(){}function k(a,b){this.filename=a||"loki.db",this.collections=[],this.databaseVersion=1.1,this.engineVersion=1.1,this.autosave=!1,this.autosaveInterval=5e3,this.autosaveHandle=null,this.options={},this.persistenceMethod=null,this.persistenceAdapter=null,this.events={init:[],flushChanges:[],close:[],changes:[],warning:[]};var c=function(){return"undefined"==typeof window?"NODEJS":"undefined"!=typeof global&&global.window?"NODEJS":"undefined"!=typeof document?-1===document.URL.indexOf("http://")&&-1===document.URL.indexOf("https://")?"CORDOVA":"BROWSER":"CORDOVA"};this.ENV=b&&b.hasOwnProperty("env")?b.env:c(),"undefined"===this.ENV&&(this.ENV="NODEJS"),this.configureOptions(b,!0),this.on("init",this.clearChanges)}function l(){this.fs=require("fs")}function m(){}function n(a,b,c,d){return this.collection=a,this.searchIsChained=!b&&!c,this.filteredrows=[],this.filterInitialized=!1,"undefined"!=typeof b&&null!==b?this.find(b,d):"undefined"!=typeof c&&null!==c?this.where(c):this}function o(a,b,c){this.collection=a,this.name=b,this.rebuildPending=!1,this.options=c||{},this.options.hasOwnProperty("persistent")||(this.options.persistent=!1),this.options.hasOwnProperty("sortPriority")||(this.options.sortPriority="passive"),this.resultset=new n(a),this.resultdata=[],this.resultsdirty=!1,this.cachedresultset=null,this.filterPipeline=[],this.sortFunction=null,this.sortCriteria=null,this.sortDirty=!1,this.events={rebuild:[]}}function p(a,b){function f(a,b,d){c.changes.push({name:a,operation:b,obj:JSON.parse(JSON.stringify(d))})}function g(){c.changes=[]}function h(a){a&&(a.meta||(a.meta={}),a.meta.created=(new Date).getTime(),a.meta.revision=0)}function i(a){a&&(a.meta.updated=(new Date).getTime(),a.meta.revision+=1)}function j(a){f(c.name,"I",a)}function k(a){f(c.name,"U",a)}function l(a){h(a),j(a)}function m(a){i(a),k(a)}function p(){n=c.disableChangesApi?h:l,o=c.disableChangesApi?i:m}this.name=a,this.data=[],this.idIndex=[],this.binaryIndices={},this.constraints={unique:{},exact:{}},this.objType=a,this.dirty=!0,this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedData=null;var c=this;b=b||{},b.hasOwnProperty("unique")&&(Array.isArray(b.unique)||(b.unique=[b.unique]),b.unique.forEach(function(a){c.constraints.unique[a]=new C(a)})),b.hasOwnProperty("exact")&&b.exact.forEach(function(a){c.constraints.exact[a]=new D(a)}),this.transactional=b.hasOwnProperty("transactional")?b.transactional:!1,this.cloneObjects=b.hasOwnProperty("clone")?b.clone:!1,this.asyncListeners=b.hasOwnProperty("asyncListeners")?b.asyncListeners:!1,this.disableChangesApi=b.hasOwnProperty("disableChangesApi")?b.disableChangesApi:!0,this.maxId=0,this.DynamicViews=[],this.events={insert:[],update:[],"pre-insert":[],"pre-update":[],close:[],flushbuffer:[],error:[],"delete":[],warning:[]},this.changes=[],this.ensureId();var d=[];if(b&&b.indices)if("[object Array]"===Object.prototype.toString.call(b.indices))d=b.indices;else{if("string"!=typeof b.indices)throw new TypeError("Indices needs to be a string or an array of strings");d=[b.indices]}for(var e=0;e<d.length;e++)this.ensureIndex(d[e]);this.getChanges=function(){return c.changes},this.flushChanges=g;var n,o;p(),this.setChangesApi=function(a){c.disableChangesApi=!a,p()},this.on("insert",function(a){n(a)}),this.on("update",function(a){o(a)}),this.on("delete",function(a){c.disableChangesApi||f(c.name,"R",a)}),this.on("warning",console.warn),g()}function q(a){return-1!==a.indexOf(".")}function r(a){return parseFloat(a,10)}function t(a,b){return a+b}function u(a,b){return a-b}function w(a){return a.reduce(t,0)/a.length}function x(a){var b=w(a),c=a.map(function(a){var c=a-b,d=c*c;return d}),d=w(c),e=Math.sqrt(d);return e}function y(a,b,c){if(c===!1)return a[b];for(var d=b.split("."),e=a;d.length>0;)e=e[d.shift()];return e}function z(a,b,c){for(var f,g,d=0,e=a.length;e>d;){if(g=0|(d+e)/2,f=c.apply(null,[b,a[g]]),0===f)return{found:!0,index:g};0>f?e=g:d=g+1}return{found:!1,index:e}}function A(a){return function(b,c){return z(b,c,a)}}function B(){}function C(a){this.field=a,this.keyMap={},this.lokiMap={}}function D(a){this.index={},this.field=a}function E(a){this.field=a}var a={copyProperties:function(a,b){var c;for(c in a)b[c]=a[c]}},f={$eq:function(a,b){return a===b},$gt:function(a,b){return c(a,b)},$gte:function(a,b){return c(a,b,!0)},$lt:function(a,c){return b(a,c)},$lte:function(a,c){return b(a,c,!0)},$ne:function(a,b){return a!==b},$regex:function(a,b){return b.test(a)},$in:function(a,b){return b.indexOf(a)>-1},$containsAny:function(a,b){var c;return Array.isArray(b)||(b=[b]),c=e(a,b)||function(){return!1},b.reduce(function(a,b){return a?a:c(b)},!1)},$contains:function(a,b){var c;return Array.isArray(b)||(b=[b]),c=e(a,b)||function(){return!0},b.reduce(function(a,b){return a?c(b):a},!0)}},g={$eq:f.$eq,$gt:f.$gt,$gte:f.$gte,$lt:f.$lt,$lte:f.$lte,$ne:f.$ne,$regex:f.$regex,$in:f.$in,$contains:f.$contains,$containsAny:f.$containsAny};return j.prototype.events={},j.prototype.asyncListeners=!1,j.prototype.on=function(a,b){var c=this.events[a];return c||(c=this.events[a]=[]),c.push(b),b},j.prototype.emit=function(a,b){var c=this;if(!a||!this.events[a])throw new Error("No event "+a+" defined");this.events[a].forEach(function(a){c.asyncListeners?setTimeout(function(){a(b)},1):a(b)})},j.prototype.removeListener=function(a,b){if(this.events[a]){var c=this.events[a];c.splice(c.indexOf(b),1)}},k.prototype=new j,k.prototype.configureOptions=function(a,b){var c={NODEJS:"fs",BROWSER:"localStorage",CORDOVA:"localStorage"},d={fs:l,localStorage:m};if(this.options={},this.persistenceMethod=null,this.persistenceAdapter=null,"undefined"!=typeof a){if(this.options=a,this.options.hasOwnProperty("persistenceMethod")&&"function"==typeof d[a.persistenceMethod]&&(this.persistenceMethod=a.persistenceMethod,this.persistenceAdapter=new d[a.persistenceMethod]),this.options.hasOwnProperty("adapter")&&(this.persistenceMethod="adapter",this.persistenceAdapter=a.adapter),a.hasOwnProperty("autoload")&&"undefined"!=typeof b&&b){var e=this;setTimeout(function(){e.loadDatabase(a,a.autoloadCallback)},1)}this.options.hasOwnProperty("autosaveInterval")&&(this.autosaveDisable(),this.autosaveInterval=parseInt(this.options.autosaveInterval,10)),this.options.hasOwnProperty("autosave")&&this.options.autosave&&(this.autosaveDisable(),this.autosave=!0,this.autosaveEnable())}null===this.persistenceAdapter&&(this.persistenceMethod=c[this.ENV],this.persistenceMethod&&(this.persistenceAdapter=new d[this.persistenceMethod]))},k.prototype.anonym=function(a,b){var c=new p("anonym",b);return c.insert(a),c},k.prototype.addCollection=function(a,b){var c=new p(a,b);return this.collections.push(c),c},k.prototype.loadCollection=function(a){if(!a.name)throw new Error("Collection must have a name property to be loaded");this.collections.push(a)},k.prototype.getCollection=function(a){var b,c=this.collections.length;for(b=0;c>b;b+=1)if(this.collections[b].name===a)return this.collections[b];return this.emit("warning","collection "+a+" not found"),null},k.prototype.listCollections=function(){for(var a=this.collections.length,b=[];a--;)b.push({name:this.collections[a].name,type:this.collections[a].objType,count:this.collections[a].data.length});return b},k.prototype.removeCollection=function(a){var b,c=this.collections.length;for(b=0;c>b;b+=1)if(this.collections[b].name===a)return this.collections.splice(b,1),void 0},k.prototype.getName=function(){return this.name},k.prototype.serializeReplacer=function(a,b){switch(a){case"autosaveHandle":case"persistenceAdapter":case"constraints":return null;default:return b}},k.prototype.serialize=function(){return JSON.stringify(this,this.serializeReplacer)},k.prototype.toJson=k.prototype.serialize,k.prototype.loadJSON=function(b,c){var g,h,i,j,d=JSON.parse(b),e=0,f=d.collections?d.collections.length:0;for(this.name=d.name,this.databaseVersion=1,d.hasOwnProperty("databaseVersion")&&(this.databaseVersion=d.databaseVersion),this.collections=[],e;f>e;e+=1){if(g=d.collections[e],h=this.addCollection(g.name),i=g.data.length,j=0,c&&c.hasOwnProperty(g.name)){var k=c[g.name].inflate?c[g.name].inflate:a.copyProperties;for(j;i>j;j++){var l=new c[g.name].proto;k(g.data[j],l),h.data[j]=l}}else for(j;i>j;j++)h.data[j]=g.data[j];if(h.transactional=g.transactional,h.asyncListeners=g.asyncListeners,h.disableChangesApi=g.disableChangesApi,h.cloneObjects=g.cloneObjects,h.maxId=0===g.data.length?0:g.maxId,h.idIndex=g.idIndex,"undefined"!=typeof g.indices&&(h.idIndex=g.indices.id),"undefined"!=typeof g.binaryIndices&&(h.binaryIndices=g.binaryIndices),h.ensureId(),"undefined"!=typeof g.DynamicViews)for(var m=0;m<g.DynamicViews.length;m++){var n=g.DynamicViews[m],o=h.addDynamicView(n.name,n.persistent);o.resultdata=n.resultdata,o.resultsdirty=n.resultsdirty,o.filterPipeline=n.filterPipeline,o.sortCriteria=n.sortCriteria,o.sortFunction=null,o.sortDirty=n.sortDirty,o.resultset.filteredrows=n.resultset.filteredrows,o.resultset.searchIsChained=n.resultset.searchIsChained,o.resultset.filterInitialized=n.resultset.filterInitialized,o.rematerialize({removeWhereFilters:!0})}}},k.prototype.close=function(a){this.autosave&&(this.autosaveDisable(),this.autosaveDirty()&&this.saveDatabase()),a&&this.on("close",a),this.emit("close")},k.prototype.generateChangesNotification=function(a){function b(a){return a.name}var c=[],d=a||this.collections.map(b);return this.collections.forEach(function(a){-1!==d.indexOf(b(a))&&(c=c.concat(a.getChanges()))}),c},k.prototype.serializeChanges=function(a){return JSON.stringify(this.generateChangesNotification(a))},k.prototype.clearChanges=function(){this.collections.forEach(function(a){a.flushChanges&&a.flushChanges()})},l.prototype.loadDatabase=function(a,b){this.fs.readFile(a,{encoding:"utf8"},function(a,c){a?b(new Error(a)):b(c)})},l.prototype.saveDatabase=function(a,b,c){this.fs.writeFile(a,b,c)},m.prototype.loadDatabase=function(a,b){i()?b(localStorage.getItem(a)):b(new Error("localStorage is not available"))},m.prototype.saveDatabase=function(a,b,c){i()?(localStorage.setItem(a,b),c(null)):c(new Error("localStorage is not available"))},k.prototype.loadDatabase=function(a,b){var c=b||function(a){if(a)throw a},d=this;null!==this.persistenceAdapter?this.persistenceAdapter.loadDatabase(this.filename,function(b){"string"==typeof b?(d.loadJSON(b,a||{}),c(null)):(console.warn("lokijs loadDatabase : Database not found"),"object"==typeof b?c(b):c("Database not found"))}):c(new Error("persistenceAdapter not configured"))},k.prototype.saveDatabase=function(a){var b=a||function(a){if(a)throw a},c=this;null!==this.persistenceAdapter?this.persistenceAdapter.saveDatabase(this.filename,c.serialize(),function(){c.autosaveClearFlags(),b(null)}):b(new Error("persistenceAdapter not configured"))},k.prototype.save=k.prototype.saveDatabase,k.prototype.autosaveDirty=function(){for(var a=0;a<this.collections.length;a++)if(this.collections[a].dirty)return!0;return!1},k.prototype.autosaveClearFlags=function(){for(var a=0;a<this.collections.length;a++)this.collections[a].dirty=!1},k.prototype.autosaveEnable=function(){this.autosave=!0;var a=5e3,b=this;"undefined"!=typeof this.autosaveInterval&&null!==this.autosaveInterval&&(a=this.autosaveInterval),this.autosaveHandle=setInterval(function(){b.autosaveDirty()&&b.saveDatabase()},a)},k.prototype.autosaveDisable=function(){"undefined"!=typeof this.autosaveHandle&&null!==this.autosaveHandle&&(clearInterval(this.autosaveHandle),this.autosaveHandle=null)},n.prototype.toJSON=function(){var a=this.copy();return a.collection=null,a},n.prototype.limit=function(a){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=Object.keys(this.collection.data));var b=this.copy();return b.filteredrows=b.filteredrows.slice(0,a),b},n.prototype.offset=function(a){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=Object.keys(this.collection.data));var b=this.copy();return b.filteredrows=b.filteredrows.splice(a,b.filteredrows.length),b},n.prototype.copy=function(){var a=new n(this.collection,null,null);return a.filteredrows=this.filteredrows.slice(),a.filterInitialized=this.filterInitialized,a},n.prototype.branch=n.prototype.copy,n.prototype.sort=function(a){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=Object.keys(this.collection.data));var b=function(a,b){return function(c,d){var e=b.collection.data[c],f=b.collection.data[d];return a(e,f)}}(a,this);return this.filteredrows.sort(b),this},n.prototype.simplesort=function(a,b){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=Object.keys(this.collection.data)),"undefined"==typeof b&&(b=!1);var c=function(a,b,c){return function(e,f){var g=c.collection.data[e],h=c.collection.data[f];return d(g[a],h[a],b)}}(a,b,this);return this.filteredrows.sort(c),this},n.prototype.compoundeval=function(a,b,c){var e=a.length;if(0===e)throw new Error("Invalid call to compoundeval, need at least one property");var f=!1,g=a[0];return"string"!=typeof g&&Array.isArray(g)&&(f=g[1],g=g[0]),b[g]===c[g]?1===e?0:this.compoundeval(a.slice(1),b,c,f):d(b[g],c[g],f)},n.prototype.compoundsort=function(a){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=Object.keys(this.collection.data));var b=function(a,b){return function(c,d){var e=b.collection.data[c],f=b.collection.data[d];return b.compoundeval(a,e,f)}}(a,this);return this.filteredrows.sort(b),this},n.prototype.calculateRange=function(a,d,e){var f=this.collection.data,g=this.collection.binaryIndices[d].values,h=0,i=g.length-1,j=null,k=0,l=g.length-1;if(0===f.length)return[0,-1];var m=f[g[h]][d],n=f[g[i]][d];switch(a){case"$eq":if(b(e,m)||c(e,n))return[0,-1];break;case"$gt":if(c(e,n,!0))return[0,-1];break;case"$gte":if(c(e,n))return[0,-1];break;case"$lt":if(b(e,m,!0))return[0,-1];if(b(n,e))return[0,f.length-1];break;case"$lte":if(b(e,m))return[0,-1];if(b(n,e,!0))return[0,f.length-1]}for(;i>h;)j=Math.floor((h+i)/2),b(f[g[j]][d],e)?h=j+1:i=j;for(k=h,h=0,i=g.length-1;i>h;)j=Math.floor((h+i)/2),b(e,f[g[j]][d])?i=j:h=j+1;l=i;var o=f[g[k]][d],p=f[g[l]][d];switch(a){case"$eq":return o!==e?[0,-1]:(p!==e&&l--,[k,l]);case"$gt":return b(p,e,!0)?[0,-1]:[l,f.length-1];case"$gte":return b(o,e)?[0,-1]:[k,f.length-1];case"$lt":return 0===k&&b(o,e)?[0,0]:[0,k-1];case"$lte":return p!==e&&l--,0===l&&b(p,e)?[0,0]:[0,l];default:return[0,f.length-1]}},n.prototype.findOr=function(a){var b=0,c=0,d=null,e=[],f=null;if(this.filterInitialized){for(e=[],c=0;c<a.length;c++)for(f=this.branch(),f.find(a[c]),f.data(),d=f.filteredrows,b=0;b<d.length;b++)-1===e.indexOf(d[b])&&e.push(d[b]);this.filteredrows=e}else for(c=0;c<a.length;c++)for(f=this.collection.chain(),f.find(a[c]),f.data(),d=f.filteredrows,b=0;b<d.length;b++)-1===this.filteredrows.indexOf(d[b])&&this.filteredrows.push(d[b]);return this.filterInitialized=!0,this},n.prototype.findAnd=function(a){for(var b=0;b<a.length;b++)this.find(a[b]);return this},n.prototype.dotSubScan=function(a,b,c,d){var f,g,i,e=null,h=b.split(".");for(f=0;f<h.length;f++)if(i=h[f],e){for(g=0;g<e.length;g++)if(c(e[g][i],d))return!0}else a=a[i],Array.isArray(a)&&(e=a);return c(a,d)},n.prototype.find=function(a,b){if(0===this.collection.data.length)return this.searchIsChained?(this.filteredrows=[],this.filterInitialized=!0,this):[];var d,e,f,h,i,m,n,o,c=a||"getAll",j=!1,k=[],l=null,p=!0;b=b||!1;for(h in c){p=!1;break}if(p&&(c="getAll"),"getAll"===c)return this.searchIsChained?(this.filteredrows=Object.keys(this.collection.data),this):this.collection.data;var q=!1;for(h in c)if(c.hasOwnProperty(h)){if(d=h,"$and"===h)return this.searchIsChained?(this.findAnd(c[h]),b&&this.filteredrows.length>1&&(this.filteredrows=this.filteredrows.slice(0,1)),this):(k=this.collection.chain().findAnd(c[h]).data(),b?0===k.length?[]:k[0]:k);if("$or"===h)return this.searchIsChained?(this.findOr(c[h]),b&&this.filteredrows.length>1&&(this.filteredrows=this.filteredrows.slice(0,1)),this):(k=this.collection.chain().findOr(c[h]).data(),b?0===k.length?[]:k[0]:k);if(-1!=h.indexOf(".")&&(q=!0),null===c[h]||"object"!=typeof c[h])f="$eq",e=c[h];else{if("object"!=typeof c[h])throw"Do not know what you want to do.";for(i in c[h])c[h].hasOwnProperty(i)&&(f=i,e=c[h][i])}break}if("$regex"===f&&(e=new RegExp(e)),null===this.collection.data)throw new TypeError;if((!this.searchIsChained||this.searchIsChained&&!this.filterInitialized)&&"$ne"!==f&&"$regex"!==f&&"$contains"!==f&&"$containsAny"!==f&&"$in"!==f&&this.collection.binaryIndices.hasOwnProperty(d)&&(this.collection.ensureIndex(d),j=!0,l=this.collection.binaryIndices[d]),m=g[f],this.searchIsChained){if(this.filterInitialized){if(j)for(n=l,o=this.filteredrows.length;o--;)m(n[this.filteredrows[o]],e)&&k.push(this.filteredrows[o]);else if(n=this.collection.data,o=this.filteredrows.length,q)for(;o--;)this.dotSubScan(n[this.filteredrows[o]],d,m,e)&&k.push(this.filteredrows[o]);else for(;o--;)m(n[this.filteredrows[o]][d],e)&&k.push(this.filteredrows[o]);return this.filteredrows=k,this}if(j){n=this.collection.data;for(var s=this.calculateRange(f,d,e,this),t=s[0];t<=s[1];t++)k.push(l.values[t]);this.filteredrows=k}else if(n=this.collection.data,o=n.length,q)for(;o--;)this.dotSubScan(n[o],d,m,e)&&k.push(o);else for(;o--;)m(n[o][d],e)&&k.push(o);return this.filteredrows=k,this.filterInitialized=!0,this}if(j){n=this.collection.data;var r=this.calculateRange(f,d,e,this);if(b)return-1!==r[1]?n[l.values[r[0]]]:[];for(o=r[0];o<=r[1];o++)k.push(n[l.values[o]]);this.filteredrows=k}else{if(n=this.collection.data,o=n.length,b){for(;o--;)if(m(n[o][d],e))return n[o];return[]}if(q)for(;o--;)this.dotSubScan(n[o],d,m,e)&&k.push(n[o]);else for(;o--;)m(n[o][d],e)&&k.push(n[o])}return k},n.prototype.where=function(a){var b,c=[];if("function"!=typeof a)throw"Argument is not a stored view or a function";b=a;try{if(this.searchIsChained){if(this.filterInitialized){for(var e=this.filteredrows.length;e--;)b(this.collection.data[this.filteredrows[e]])===!0&&c.push(this.filteredrows[e]);return this.filteredrows=c,this}for(var f=this.collection.data.length;f--;)b(this.collection.data[f])===!0&&c.push(f);return this.filteredrows=c,this.filterInitialized=!0,this}for(var d=this.collection.data.length;d--;)b(this.collection.data[d])===!0&&c.push(this.collection.data[d]);return c}catch(g){throw g}},n.prototype.data=function(){var a=[];if(this.searchIsChained&&!this.filterInitialized){if(0===this.filteredrows.length)return this.collection.data;this.filterInitialized=!0}var d,b=this.collection.data,c=this.filteredrows,e=this.filteredrows.length;for(d=0;e>d;d++)a.push(b[c[d]]);return a},n.prototype.update=function(a){if("function"!=typeof a)throw"Argument is not a function";this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=Object.keys(this.collection.data));for(var b=this.filteredrows.length,c=this.collection.data,d=0;b>d;d++)a(c[this.filteredrows[d]]),this.collection.update(c[this.filteredrows[d]]);return this},n.prototype.remove=function(){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=Object.keys(this.collection.data));for(var a=this.filteredrows.length,b=0;a>b;b++)this.collection.remove(this.filteredrows[b]);return this.filteredrows=[],this},n.prototype.mapReduce=function(a,b){try{return b(this.data().map(a))}catch(c){throw c}},n.prototype.eqJoin=function(a,b,c,d){var f,h,i,e=[],g=[],j=[],l="function"==typeof b,m="function"==typeof c,o={};if(e=this.data(),f=e.length,a instanceof n)g=a.data();else{if(!Array.isArray(a))throw new TypeError("joinData needs to be an array or result set");g=a}h=g.length;for(var q=0;h>q;q++)i=m?c(g[q]):g[q][c],o[i]=g[q];d||(d=function(a,b){return{left:a,right:b}});for(var r=0;f>r;r++)i=l?b(e[r]):e[r][b],j.push(d(e[r],o[i]||{}));return this.collection=new p("joinData"),this.collection.insert(j),this.filteredrows=[],this.filterInitialized=!1,this},n.prototype.map=function(a){var b=this.data().map(a);return this.collection=new p("mappedData"),this.collection.insert(b),this.filteredrows=[],this.filterInitialized=!1,this},o.prototype=new j,o.prototype.rematerialize=function(a){var b,c,d;if(a=a||{},this.resultdata=[],this.resultsdirty=!0,this.resultset=new n(this.collection),(this.sortFunction||this.sortCriteria)&&(this.sortDirty=!0),a.hasOwnProperty("removeWhereFilters"))for(b=this.filterPipeline.length,c=b;c--;)"where"===this.filterPipeline[c].type&&(c!==this.filterPipeline.length-1&&(this.filterPipeline[c]=this.filterPipeline[this.filterPipeline.length-1]),this.filterPipeline.length--);var e=this.filterPipeline;for(this.filterPipeline=[],b=e.length,d=0;b>d;d++)this.applyFind(e[d].val);return this.data(),this.emit("rebuild",this),this},o.prototype.branchResultset=function(){return this.resultset.copy()},o.prototype.toJSON=function(){var a=new o(this.collection,this.name,this.options);return a.resultset=this.resultset,a.resultdata=[],a.resultsdirty=!0,a.filterPipeline=this.filterPipeline,a.sortFunction=this.sortFunction,a.sortCriteria=this.sortCriteria,a.sortDirty=this.sortDirty,a.collection=null,a},o.prototype.applySort=function(a){return this.sortFunction=a,this.sortCriteria=null,this.queueSortPhase(),this},o.prototype.applySimpleSort=function(a,b){return"undefined"==typeof b&&(b=!1),this.sortCriteria=[[a,b]],this.sortFunction=null,this.queueSortPhase(),this},o.prototype.applySortCriteria=function(a){return this.sortCriterial=a,this.sortFunction=null,this.queueSortPhase(),this},o.prototype.startTransaction=function(){return this.cachedresultset=this.resultset.copy(),this},o.prototype.commit=function(){return this.cachedresultset=null,this},o.prototype.rollback=function(){return this.resultset=this.cachedresultset,this.options.persistent&&(this.resultdata=this.resultset.data(),this.emit("rebuild",this)),this},o.prototype.applyFind=function(a){return this.filterPipeline.push({type:"find",val:a}),this.resultset.find(a),(this.sortFunction||this.sortCriteria)&&(this.sortDirty=!0,this.queueSortPhase()),this.options.persistent&&(this.resultsdirty=!0,this.queueSortPhase()),this},o.prototype.applyWhere=function(a){return this.filterPipeline.push({type:"where",val:a}),this.resultset.where(a),(this.sortFunction||this.sortCriteria)&&(this.sortDirty=!0,this.queueSortPhase()),this.options.persistent&&(this.resultsdirty=!0,this.queueSortPhase()),this},o.prototype.data=function(){return(this.sortDirty||this.resultsdirty||!this.resultset.filterInitialized)&&this.performSortPhase(),this.options.persistent?this.resultdata:this.resultset.data()},o.prototype.queueRebuildEvent=function(){var a=this;this.rebuildPending||(this.rebuildPending=!0,setTimeout(function(){a.rebuildPending=!1,a.emit("rebuild",this)},1))},o.prototype.queueSortPhase=function(){var a=this;this.sortDirty||(this.sortDirty=!0,"active"===this.options.sortPriority?setTimeout(function(){a.performSortPhase()},1):this.queueRebuildEvent())},o.prototype.performSortPhase=function(){if(this.sortDirty||this.resultsdirty||!this.resultset.filterInitialized){if(this.sortFunction&&this.resultset.sort(this.sortFunction),this.sortCriteria&&this.resultset.compoundsort(this.sortCriteria),!this.options.persistent)return this.sortDirty=!1,void 0;this.resultdata=this.resultset.data(),this.resultsdirty=!1,this.sortDirty=!1,this.emit("rebuild",this)}},o.prototype.evaluateDocument=function(a){var b=this.resultset.filteredrows,c=b.indexOf(a),d=b.length,e=new n(this.collection);e.filteredrows=[a],e.filterInitialized=!0;for(var f=0;f<this.filterPipeline.length;f++)switch(this.filterPipeline[f].type){case"find":e.find(this.filterPipeline[f].val);break;case"where":e.where(this.filterPipeline[f].val)}var g=0===e.filteredrows.length?-1:0;return-1!=c||-1!=g?-1===c&&-1!==g?(b.push(a),this.options.persistent&&this.resultdata.push(this.collection.data[a]),this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent(),void 0):-1!==c&&-1===g?(d-1>c?(b[c]=b[d-1],b.length=d-1,this.options.persistent&&(this.resultdata[c]=this.resultdata[d-1],this.resultdata.length=d-1)):(b.length=d-1,this.options.persistent&&(this.resultdata.length=d-1)),this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent(),void 0):-1!==c&&-1!==g?(this.options.persistent&&(this.resultdata[c]=this.collection.data[a]),this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent(),void 0):void 0:void 0},o.prototype.removeDocument=function(a){var e,b=this.resultset.filteredrows,c=b.indexOf(a),d=b.length;for(-1!==c&&(d-1>c?(b[c]=b[d-1],b.length=d-1,this.options.persistent&&(this.resultdata[c]=this.resultdata[d-1],this.resultdata.length=d-1)):(b.length=d-1,this.options.persistent&&(this.resultdata.length=d-1)),(this.sortFunction||this.sortCriteria)&&this.queueSortPhase()),d=b.length,e=0;d>e;e++)b[e]>a&&b[e]--},o.prototype.mapReduce=function(a,b){try{return b(this.data().map(a))}catch(c){throw c}},p.prototype=new j,p.prototype.byExample=function(a){var b,c,d;d=[];for(b in a)a.hasOwnProperty(b)&&d.push((c={},c[b]=a[b],c));return{$and:d}},p.prototype.findObject=function(a){return this.findOne(this.byExample(a))},p.prototype.findObjects=function(a){return this.find(this.byExample(a))},p.prototype.ensureIndex=function(a,d){if("undefined"==typeof d&&(d=!1),null===a||void 0===a)throw"Attempting to set index without an associated property";if(!this.binaryIndices.hasOwnProperty(a)||d||this.binaryIndices[a].dirty){this.binaryIndices[a]={name:a,dirty:!0,values:[]};var e,f=this.data.length,g=0;for(e=this.binaryIndices[a],g;f>g;g+=1)e.values.push(g);var h=function(a,d){return function(e,f){var g=d.data[e],h=d.data[f];return g[a]===h[a]?0:c(g[a],h[a])?1:b(g[a],h[a])?-1:void 0}}(a,this);e.values.sort(h),e.dirty=!1,this.dirty=!0}},p.prototype.ensureUniqueIndex=function(a){var b=this.constraints.unique[a];return b||(this.constraints.unique[a]=b=new C(a)),this.data.forEach(function(a){b.set(a)}),b},p.prototype.ensureAllIndexes=function(a){for(var b=Object.keys(this.binaryIndices),c=b.length;c--;)this.ensureIndex(b[c],a)},p.prototype.flagBinaryIndexesDirty=function(){for(var a=Object.keys(this.binaryIndices),b=a.length;b--;)this.binaryIndices[a[b]].dirty=!0},p.prototype.count=function(){return this.data.length},p.prototype.ensureId=function(){var a=this.data.length,b=0;for(this.idIndex=[],b;a>b;b+=1)this.idIndex.push(this.data[b].$loki)},p.prototype.ensureIdAsync=function(a){this.async(function(){this.ensureId()},a)},p.prototype.addDynamicView=function(a,b){var c=new o(this,a,b);return this.DynamicViews.push(c),c},p.prototype.removeDynamicView=function(a){for(var b=0;b<this.DynamicViews.length;b++)this.DynamicViews[b].name===a&&this.DynamicViews.splice(b,1)},p.prototype.getDynamicView=function(a){for(var b=0;b<this.DynamicViews.length;b++)if(this.DynamicViews[b].name===a)return this.DynamicViews[b];return null},p.prototype.findAndUpdate=function(a,b){var e,c=this.where(a),d=0;try{for(d;d<c.length;d++)e=b(c[d]),this.update(e)}catch(f){this.rollback(),console.error(f.message)}},p.prototype.insert=function(a){if(!a){var b=new Error("Object cannot be null");throw this.emit("error",b),b}var d,c=this,e=Array.isArray(a)?a:[a],f=[];return e.forEach(function(a){if("object"!=typeof a)throw new TypeError("Document needs to be an object");return d=c.cloneObjects?JSON.parse(JSON.stringify(a)):a,"undefined"==typeof d.meta&&(d.meta={revision:0,created:0}),c.emit("pre-insert",d),c.add(d)?(c.emit("insert",d),f.push(d),void 0):void 0}),1===f.length?f[0]:f},p.prototype.clear=function(){this.data=[],this.idIndex=[],this.binaryIndices={},this.cachedIndex=null,this.cachedData=null,this.maxId=0,this.DynamicViews=[],this.dirty=!0},p.prototype.update=function(a){if(Object.keys(this.binaryIndices).length>0&&this.flagBinaryIndexesDirty(),Array.isArray(a)){var b=0,c=a.length;for(b;c>b;b+=1)this.update(a[b])}else{if(!a.hasOwnProperty("$loki"))throw"Trying to update unsynced document. Please save the document first by using insert() or addMany()";try{this.startTransaction();var e,f,d=this.get(a.$loki,!0),g=this;if(!d)throw new Error("Trying to update a document not in collection.");this.emit("pre-update",a),e=d[0],Object.keys(this.constraints.unique).forEach(function(a){g.constraints.unique[a].update(e)}),f=d[1],this.data[f]=a;for(var h=0;h<this.DynamicViews.length;h++)this.DynamicViews[h].evaluateDocument(f);this.idIndex[f]=e.$loki,this.commit(),this.dirty=!0,this.emit("update",a)}catch(i){throw this.rollback(),console.error(i.message),this.emit("error",i),i}}},p.prototype.add=function(a){var b=this.DynamicViews.length;if("object"!=typeof a)throw"Object being added needs to be an object";if(Object.keys(this.binaryIndices).length>0&&this.flagBinaryIndexesDirty(),"undefined"!=typeof a.$loki)throw"Document is already in collection, please use update()";try{this.startTransaction(),this.maxId++,isNaN(this.maxId)&&(this.maxId=this.data[this.data.length-1].$loki+1),a.$loki=this.maxId,a.meta.version=0,this.data.push(a);var c=this;Object.keys(this.constraints.unique).forEach(function(b){c.constraints.unique[b].set(a)});for(var d=0;b>d;d++)this.DynamicViews[d].evaluateDocument(this.data.length-1);return this.idIndex.push(a.$loki),this.commit(),this.dirty=!0,a}catch(e){this.rollback(),console.error(e.message)}},p.prototype.removeWhere=function(a){var b;b="function"==typeof a?this.data.filter(a):new n(this,a);for(var c=b.length;c--;)this.remove(b[c]);var d;for(d in this.DynamicViews)this.DynamicViews[d].rematerialize()},p.prototype.removeDataOnly=function(){this.removeWhere(function(){return!0})},p.prototype.remove=function(a){if("number"==typeof a&&(a=this.get(a)),"object"!=typeof a)throw new Error("Parameter is not an object");if(Array.isArray(a)){var b=0,c=a.length;for(b;c>b;b+=1)this.remove(a[b])}else{if(!a.hasOwnProperty("$loki"))throw new Error("Object is not a document stored in the collection");Object.keys(this.binaryIndices).length>0&&this.flagBinaryIndexesDirty();try{this.startTransaction();var d=this.get(a.$loki,!0),e=d[1],f=this;Object.keys(this.constraints.unique).forEach(function(b){null!==a[b]&&"undefined"!=typeof a[b]&&f.constraints.unique[b].remove(a[b])});for(var g=0;g<this.DynamicViews.length;g++)this.DynamicViews[g].removeDocument(e);return this.data.splice(e,1),this.idIndex.splice(e,1),this.commit(),this.dirty=!0,this.emit("delete",d[0]),delete a.$loki,delete a.meta,a}catch(h){return this.rollback(),console.error(h.message),this.emit("error",h),null}}},p.prototype.get=function(a,b){var c=b||!1,d=this.idIndex,e=d.length-1,f=0,g=Math.floor(f+(e-f)/2);if(a="number"==typeof a?a:parseInt(a,10),isNaN(a))throw"Passed id is not an integer";for(;d[f]<d[e];)g=Math.floor((f+e)/2),d[g]<a?f=g+1:e=g;return e===f&&d[f]===a?c?[this.data[f],f]:this.data[f]:null},p.prototype.by=function(a,b){var c;return b?this.constraints.unique[a].get(b):(c=this,function(b){return c.by(a,b)})},p.prototype.findOne=function(a){var b=new n(this,a,null,!0);return Array.isArray(b)&&0===b.length?null:b},p.prototype.chain=function(){return new n(this,null,null)},p.prototype.find=function(a){return"undefined"==typeof a&&(a="getAll"),new n(this,a,null)
},p.prototype.findOneUnindexed=function(a,b){for(var d,c=this.data.length;c--;)if(this.data[c][a]===b)return d=this.data[c];return null},p.prototype.startTransaction=function(){if(this.transactional){this.cachedData=h(this.data,"parse-stringify"),this.cachedIndex=this.idIndex,this.cachedBinaryIndex=this.binaryIndices;for(var a=0;a<this.DynamicViews.length;a++)this.DynamicViews[a].startTransaction()}},p.prototype.commit=function(){if(this.transactional){this.cachedData=null,this.cachedIndex=null,this.cachedBinaryIndices=null;for(var a=0;a<this.DynamicViews.length;a++)this.DynamicViews[a].commit()}},p.prototype.rollback=function(){if(this.transactional){null!==this.cachedData&&null!==this.cachedIndex&&(this.data=this.cachedData,this.idIndex=this.cachedIndex,this.binaryIndices=this.cachedBinaryIndex);for(var a=0;a<this.DynamicViews.length;a++)this.DynamicViews[a].rollback()}},p.prototype.async=function(a,b){setTimeout(function(){if("function"!=typeof a)throw"Argument passed for async execution is not a function";a(),b()},0)},p.prototype.where=function(a){return new n(this,null,a)},p.prototype.mapReduce=function(a,b){try{return b(this.data.map(a))}catch(c){throw c}},p.prototype.eqJoin=function(a,b,c,d){return new n(this).eqJoin(a,b,c,d)},p.prototype.stages={},p.prototype.getStage=function(a){return this.stages[a]||(this.stages[a]={}),this.stages[a]},p.prototype.commitLog=[],p.prototype.stage=function(a,b){var c=JSON.parse(JSON.stringify(b));return this.getStage(a)[b.$loki]=c,c},p.prototype.commitStage=function(a,b){var d,c=this.getStage(a),e=(new Date).getTime();for(d in c)this.update(c[d]),this.commitLog.push({timestamp:e,message:b,data:JSON.parse(JSON.stringify(c[d]))});this.stages[a]={}},p.prototype.no_op=function(){},p.prototype.extract=function(a){var b=0,c=this.data.length,d=q(a),e=[];for(b;c>b;b+=1)e.push(y(this.data[b],a,d));return e},p.prototype.max=function(a){return Math.max.apply(null,this.extract(a))},p.prototype.min=function(a){return Math.min.apply(null,this.extract(a))},p.prototype.maxRecord=function(a){var f,b=0,c=this.data.length,d=q(a),e={index:0,value:void 0};for(b;c>b;b+=1)void 0!==f?f<y(this.data[b],a,d)&&(f=y(this.data[b],a,d),e.index=this.data[b].$loki):(f=y(this.data[b],a,d),e.index=this.data[b].$loki);return e.value=f,e},p.prototype.minRecord=function(a){var f,b=0,c=this.data.length,d=q(a),e={index:0,value:void 0};for(b;c>b;b+=1)void 0!==f?f>y(this.data[b],a,d)&&(f=y(this.data[b],a,d),e.index=this.data[b].$loki):(f=y(this.data[b],a,d),e.index=this.data[b].$loki);return e.value=f,e},p.prototype.extractNumerical=function(a){return this.extract(a).map(r).filter(Number).filter(function(a){return!isNaN(a)})},p.prototype.avg=function(a){return w(this.extractNumerical(a))},p.prototype.stdDev=function(a){return x(this.extractNumerical(a))},p.prototype.mode=function(a){var b={},c=this.extract(a);c.forEach(function(a){b[a]?b[a]+=1:b[a]=1});var d,e,f;for(e in b)d?d<b[e]&&(f=e):(f=e,d=b[e]);return f},p.prototype.median=function(a){var b=this.extractNumerical(a);b.sort(u);var c=Math.floor(b.length/2);return b.length%2?b[c]:(b[c-1]+b[c])/2},B.prototype={keys:[],values:[],sort:function(a,b){return b>a?-1:a>b?1:0},setSort:function(a){this.bs=new A(a)},bs:function(){return new A(this.sort)},set:function(a,b){var c=this.bs(this.keys,a);c.found?this.values[c.index]=b:(this.keys.splice(c.index,0,a),this.values.splice(c.index,0,b))},get:function(a){return this.values[z(this.keys,a,this.sort).index]}},C.prototype.keyMap={},C.prototype.lokiMap={},C.prototype.set=function(a){if(null!==a[this.field]&&"undefined"!=typeof a[this.field]){if(this.keyMap[a[this.field]])throw new Error("Duplicate key for property "+this.field+": "+a[this.field]);this.keyMap[a[this.field]]=a,this.lokiMap[a.$loki]=a[this.field]}},C.prototype.get=function(a){return this.keyMap[a]},C.prototype.byId=function(a){return this.keyMap[this.lokiMap[a]]},C.prototype.update=function(a){if(this.lokiMap[a.$loki]!==a[this.field]){var b=this.lokiMap[a.$loki];this.set(a),this.keyMap[b]=void 0}else this.keyMap[a[this.field]]=a},C.prototype.remove=function(a){var b=this.keyMap[a];if(null===b||"undefined"==typeof b)throw new Error("Key is not in unique index: "+this.field);this.keyMap[a]=void 0,this.lokiMap[b.$loki]=void 0},C.prototype.clear=function(){this.keyMap={},this.lokiMap={}},D.prototype={set:function(a,b){this.index[a]?this.index[a].push(b):this.index[a]=[b]},remove:function(a,b){var c=this.index[a];for(var d in c)c[d]==b&&c.splice(d,1);c.length<1&&(this.index[a]=void 0)},get:function(a){return this.index[a]},clear:function(){this.index={}}},E.prototype={keys:[],values:[],sort:function(a,b){return b>a?-1:a>b?1:0},bs:function(){return new A(this.sort)},setSort:function(a){this.bs=new A(a)},set:function(a,b){var c=z(this.keys,a,this.sort);c.found?this.values[c.index].push(b):(this.keys.splice(c.index,0,a),this.values.splice(c.index,0,[b]))},get:function(a){var b=z(this.keys,a,this.sort);return b.found?this.values[b.index]:[]},getLt:function(a){var b=z(this.keys,a,this.sort),c=b.index;return b.found&&c--,this.getAll(a,0,c)},getGt:function(a){var b=z(this.keys,a,this.sort),c=b.index;return b.found&&c++,this.getAll(a,c,this.keys.length)},getAll:function(a,b,c){for(var d=[],e=b;c>e;e++)d=d.concat(this.values[e]);return d},getPos:function(a){return z(this.keys,a,this.sort)},remove:function(a,b){var c=z(this.keys,a,this.sort).index,d=this.values[c];for(var e in d)d[e]==b&&d.splice(e,1);d.length<1&&(this.keys.splice(c,1),this.values.splice(c,1))},clear:function(){this.keys=[],this.values=[]}},k.Collection=p,k.KeyValueStore=B,k}()});